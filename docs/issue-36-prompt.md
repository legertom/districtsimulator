> Copy-paste this entire document into a new AI chat session pointed at the District Simulator repo.
> The bot should execute all tasks, run tests, lint, and commit.

# Issue #36 — Wire Dynamic Data to IDM Page + Profiles

**Sprint:** mar-02-06 | **Day:** Tuesday | **Depends on:** Issue #35 (provisioning engine)

## Overview

When provisioning results exist in localStorage, the IDM page should display dynamically generated events and sync history instead of the static defaults. Profile pages should match by person ID instead of name heuristics.

**3 tasks, 0 new files, 3 modified files. Follow task order.**

After this issue:
- IDM Events tab shows generated events when provisioning results exist
- IDM Sync History tab shows generated sync history
- Profile IDM section shows the actual provisioned email/OU from generated events
- `findProfileIdForEvent` matches by `personId` when available (not just name heuristics)
- Falls back to static data when no provisioning results exist (backward compatibility)

---

## Task 1: IDM Page Dynamic Events + Sync History

Modify `src/components/pages/IDM.jsx`.

### 1A: Read provisioning results from localStorage

At the top of the `IDM` component function (after line 93 `const idm = resolvedData?.idm ?? {};`), add:

```js
// Read dynamic provisioning results (generated by the engine in Issue #35)
const [dynamicEvents, setDynamicEvents] = useState(null);
const [dynamicSyncHistory, setDynamicSyncHistory] = useState(null);

useEffect(() => {
    if (!idmSetupComplete) return;
    try {
        const eventsRaw = localStorage.getItem("idm-provisioning-results");
        if (eventsRaw) {
            const parsed = JSON.parse(eventsRaw);
            setDynamicEvents(parsed.events || null);
        }
        const syncRaw = localStorage.getItem("idm-provisioning-sync-history");
        if (syncRaw) {
            setDynamicSyncHistory(JSON.parse(syncRaw));
        }
    } catch {
        // Fall back to static data
    }
}, [idmSetupComplete]);
```

### 1B: Use dynamic data with fallback

Change the existing lines that read static data (around lines 94-96):

**Before:**
```js
const configuredDestinations = idm.destinations ?? [];
const syncHistory = idm.syncHistory ?? [];
const allEvents = idm.events ?? [];
```

**After:**
```js
const configuredDestinations = idm.destinations ?? [];
const syncHistoryData = dynamicSyncHistory || (idm.syncHistory ?? []);
const allEvents = dynamicEvents || (idm.events ?? []);
```

Then find every reference to `syncHistory` in the component and rename it to `syncHistoryData` (it's used in the Sync History tab table). Use your editor's find/replace — there are approximately 4-5 references:
- The `syncHistory` variable declaration → `syncHistoryData`
- All uses in JSX where `syncHistory.map(...)` or `syncHistory.length` → `syncHistoryData.map(...)` or `syncHistoryData.length`

**Important:** Only rename the *variable* references, not the tab label strings like `"Sync History"`.

### 1C: Update the Google Workspace stats card

When `dynamicEvents` exist, the Google provider card should show updated stats. Find the section that shows "Managing N Google users" or the sync stats card. Update the user count to reflect the dynamic event count:

Find any hardcoded references to user counts in the Google Workspace provider card section and replace with:
```js
const totalProvisionedUsers = allEvents.length;
```

Use `totalProvisionedUsers` where the card displays the managed user count.

### 1D: Update `findProfileIdForEvent` to prefer personId

Modify the `findProfileIdForEvent` function (lines 70-87) to prefer the `personId` field when available:

**Before:**
```js
function findProfileIdForEvent(ev, scenarioData) {
    const userType = ev.userType?.toLowerCase();
    const nameParts = ev.user?.split(" ") || [];
    const firstName = nameParts[0]?.toLowerCase();
    const lastName = nameParts[nameParts.length - 1]?.toLowerCase();

    let collection;
    if (userType === "student") collection = scenarioData.dataBrowser?.students;
    else if (userType === "teacher") collection = scenarioData.dataBrowser?.teachers;
    else if (userType === "staff") collection = scenarioData.dataBrowser?.staff;

    if (!collection || !firstName || !lastName) return null;

    const match = collection.find(
        (p) => p.first?.toLowerCase() === firstName && p.last?.toLowerCase() === lastName
    );
    return match ? { id: match.id, userType: ev.userType } : null;
}
```

**After:**
```js
function findProfileIdForEvent(ev, scenarioData) {
    // Prefer personId from engine-generated events (exact match)
    if (ev.personId) {
        return { id: ev.personId, userType: ev.userType };
    }

    // Fall back to name-based heuristic for static events
    const userType = ev.userType?.toLowerCase();
    const nameParts = ev.user?.split(" ") || [];
    const firstName = nameParts[0]?.toLowerCase();
    const lastName = nameParts[nameParts.length - 1]?.toLowerCase();

    let collection;
    if (userType === "student") collection = scenarioData.dataBrowser?.students;
    else if (userType === "teacher") collection = scenarioData.dataBrowser?.teachers;
    else if (userType === "staff") collection = scenarioData.dataBrowser?.staff;

    if (!collection || !firstName || !lastName) return null;

    const match = collection.find(
        (p) => p.first?.toLowerCase() === firstName && p.last?.toLowerCase() === lastName
    );
    return match ? { id: match.id, userType: ev.userType } : null;
}
```

**Commit 1:** `feat: IDM page reads dynamic provisioning results with static fallback`

---

## Task 2: Profile IDM Section — Read Provisioning Results

Modify `src/components/pages/profiles/CleverIDMSection.jsx`.

Currently this component reads the wizard config from localStorage and computes email via regex replacement. Change it to first check for generated provisioning results (which have the exact computed email and OU), falling back to the current behavior.

**Replace the entire file content with:**

```jsx
"use client";

import { useMemo } from "react";
import { useInstructional } from "@/context/InstructionalContext";
import styles from "./ProfilePage.module.css";

/**
 * "Clever IDM Information" card for profile Details tabs.
 * Only renders when IDM setup is complete.
 *
 * Reads provisioning results first (exact computed values from the engine).
 * Falls back to regex-based computation from wizard config if no results exist.
 *
 * @param {{ userType: "student"|"teacher"|"staff", person: object }} props
 */
export default function CleverIDMSection({ userType, person }) {
    const { idmSetupComplete } = useInstructional();

    // Try provisioning results first (generated by the engine)
    const provisionedEvent = useMemo(() => {
        if (typeof window === "undefined" || !person?.id) return null;
        try {
            const raw = localStorage.getItem("idm-provisioning-results");
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            const events = parsed.events || [];
            return events.find((ev) => ev.personId === person.id) || null;
        } catch {
            return null;
        }
    }, [person?.id]);

    // Fallback: read provisioning config from localStorage (set by the wizard)
    const provisioningConfig = useMemo(() => {
        if (provisionedEvent) return null; // Don't need config if we have exact results
        if (typeof window === "undefined") return null;
        try {
            const raw = localStorage.getItem("idm-provisioning-state");
            return raw ? JSON.parse(raw) : null;
        } catch {
            return null;
        }
    }, [provisionedEvent]);

    if (!idmSetupComplete) return null;

    // Use provisioned event data if available, otherwise compute from config
    const googleEmail = provisionedEvent
        ? provisionedEvent.destinationUsername
        : computeEmail(provisioningConfig, userType, person) || "—";
    const googleId = provisionedEvent ? provisionedEvent.cleverId : "—";
    const googleOU = provisionedEvent ? provisionedEvent.currentOU : null;

    return (
        <div className={styles.card}>
            <h2 className={styles.cardHeader}>Clever IDM Information</h2>
            <div className={styles.fieldGrid}>
                <Field label="Google Email" value={googleEmail} />
                <Field label="Google ID" value={googleId} />
                {googleOU && <Field label="Google OU" value={googleOU} />}
                {userType !== "staff" && (
                    <Field label="Google Password" value="••••••••" />
                )}
                <div className={styles.fieldGroup}>
                    <span className={styles.fieldLabel}>Actions</span>
                    <span className={styles.fieldLink}>Unlink user</span>
                </div>
            </div>
        </div>
    );
}

function Field({ label, value }) {
    return (
        <div className={styles.fieldGroup}>
            <span className={styles.fieldLabel}>{label}</span>
            <span className={value && value !== "—" ? styles.fieldValue : styles.fieldEmpty}>
                {value || "—"}
            </span>
        </div>
    );
}

// ── Helpers ─────────────────────────────────────────────────

function computeEmail(config, userType, person) {
    const typeKey = userType + "s"; // "students", "teachers", "staff" → "staffs" is fine, will fallback
    const cred = config?.credentials?.[typeKey] || config?.credentials?.[userType];
    if (!cred?.email || !person) return null;
    const domain = cred.domain || "cedarridgesd.org";
    const first = person.first?.toLowerCase() || "";
    const last = person.last?.toLowerCase() || "";
    let email = cred.email
        .replace(/\{\{name\.first\}\}/gi, first)
        .replace(/\{\{name\.last\}\}/gi, last)
        .replace(/\{\{name\.first_initial\}\}/gi, first.charAt(0));
    if (!email.includes("@")) {
        email = `${first}.${last}@${domain}`;
    }
    return email;
}
```

**Commit 2:** `feat: profile IDM section reads provisioning results with fallback`

---

## Task 3: InstructionalContext — Parallel Fetch Wizard State

Modify `src/context/InstructionalContext.jsx`.

In the Phase 2 async DB load (line 317-380), add `fetchWizardStateFromApi` to the parallel fetch.

### 3A: Add import

At the top of the file, find the import from `@/lib/progressApi`:
```js
import {
    fetchProgressFromApi,
    fetchSessionStateFromApi,
    ...
} from "@/lib/progressApi";
```

Add `fetchWizardStateFromApi` to the import:
```js
import {
    fetchProgressFromApi,
    fetchSessionStateFromApi,
    fetchWizardStateFromApi,
    ...
} from "@/lib/progressApi";
```

### 3B: Add wizard state to the parallel fetch

Find the Phase 2 Promise.all (around line 326):
```js
const [progressData, sessionData] = await Promise.all([
    fetchProgressFromApi(),
    fetchSessionStateFromApi(),
]);
```

Change to:
```js
const [progressData, sessionData, wizardData] = await Promise.all([
    fetchProgressFromApi(),
    fetchSessionStateFromApi(),
    fetchWizardStateFromApi(),
]);
```

### 3C: Apply wizard state to localStorage if newer

After the session recovery block (around line 372, before the `catch`), add:

```js
// Apply wizard state from DB to localStorage if available
if (wizardData?.wizard_data) {
    try {
        const localWizard = localStorage.getItem("idm-provisioning-state");
        // DB takes precedence if local is empty
        if (!localWizard) {
            localStorage.setItem("idm-provisioning-state", JSON.stringify(wizardData.wizard_data));
        }
        // Also restore provisioning results if they exist in the DB data
        if (wizardData.wizard_data.provisioning_results) {
            const localResults = localStorage.getItem("idm-provisioning-results");
            if (!localResults) {
                localStorage.setItem("idm-provisioning-results", JSON.stringify(wizardData.wizard_data.provisioning_results));
            }
        }
    } catch {
        // ignore localStorage errors
    }
}
```

**Commit 3:** `feat: InstructionalContext Phase 2 fetches wizard state in parallel`

---

## Verification

```bash
npx eslint src/           # 0 errors
npx vitest run            # all tests pass
```

Manual checks:
- [ ] Run Scenario 1 through provisioning. After provisioning, check the IDM Events tab — should show 40 dynamically generated events (not the static 19)
- [ ] Click "Open Profile" on a dynamic event — should navigate to the correct profile page
- [ ] Profile's "Clever IDM Information" card should show the provisioned email and Clever ID
- [ ] Clear `idm-provisioning-results` from localStorage → IDM page falls back to static events

## File Summary

| Action | File |
|--------|------|
| Modify | `src/components/pages/IDM.jsx` |
| Modify | `src/components/pages/profiles/CleverIDMSection.jsx` |
| Modify | `src/context/InstructionalContext.jsx` |
