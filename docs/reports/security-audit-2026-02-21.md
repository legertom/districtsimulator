# Application Security Audit Report: District Simulator

**Date:** February 21, 2026  
**Auditor:** Senior Application Security Engineer (automated review)  
**Scope:** Auth/session handling, env/secret management, route protection, data exposure, unsafe defaults, dependency risk, CI/release safeguards  
**Commit:** HEAD on `main`

---

## Executive Summary

The District Simulator is a Next.js 16 training application deployed on Vercel with NextAuth.js authentication. While previous security hardening phases (1–4) introduced useful primitives (rate limiting, redirect validation, structured audit logging, CSP headers), **the application has a critical architectural gap: the route-protection middleware is defined but never loaded by Next.js**, leaving every dashboard route publicly accessible without authentication. Additionally, real secrets (a Vercel OIDC JWT and a production-strength NEXTAUTH_SECRET) are present on disk in `.env.local`, and the hardcoded credential pair (`admin@clever.com` / `password`) ships in source code. A total of **3 P0, 4 P1, and 5 P2** findings are documented below.

**Risk Rating: HIGH** — The P0 middleware gap means the authentication boundary described in `SECURITY_BRIEF.md` and `proxy.js` does not actually function.

---

## Findings

### P0 — Critical (Immediate Action Required)

#### P0-1: Route Protection Middleware Is Inert — All Dashboard Routes Are Unauthenticated

| Detail | Value |
|--------|-------|
| **File** | `src/proxy.js` (should be `middleware.js` or `src/middleware.js`) |
| **Impact** | Any unauthenticated user can access `/dashboard/*`, `/`, and all other routes |

**Evidence:**  
- `src/proxy.js` defines `withAuth` and a `config.matcher`, but Next.js only auto-loads middleware from a file named `middleware.js` (or `middleware.ts`) at the project root **or** inside `src/`.  
- No file named `middleware.js` exists anywhere:
  ```
  $ find . -name "middleware*" -not -path "./node_modules/*"
  (no results)
  ```
- `proxy.js` is never imported by any other file:
  ```
  $ grep -rn "proxy" src/ --include="*.js" --include="*.jsx" | grep -v __tests__ | grep -v .css
  src/proxy.js:9:export const proxy = withAuth({
  src/proxy.js:18: * Specifies which paths the proxy should run on.
  ```
- No server-side session checks (`getServerSession`, `getSession`, `auth()`) exist in any `page.js` or `layout.js` under `src/app/dashboard/`.
- The only `useSession` calls are cosmetic (TopNav avatar display, PortalLobby greeting) — they do **not** gate access.

**Result:** The entire application is accessible without logging in. The authentication wall described in `SECURITY_BRIEF.md` §4B ("Global Middleware … Deny-by-Default") is a documentation claim with no runtime enforcement.

**Fix:**  
Rename `src/proxy.js` → `src/middleware.js` (or create `middleware.js` in the project root that re-exports it). Verify with an E2E test that unauthenticated requests to `/dashboard/admin-team` return a 307 redirect to `/login`.

---

#### P0-2: Real Secrets Committed to Disk — Vercel OIDC Token & NEXTAUTH_SECRET in `.env.local`

| Detail | Value |
|--------|-------|
| **File** | `.env.local` |
| **Impact** | Credential exposure; Vercel project impersonation risk |

**Evidence:**  
`.env.local` contains:
```
VERCEL_OIDC_TOKEN="eyJhbGciOiJSUzI1NiIs…" (full RS256 JWT)
NEXTAUTH_SECRET=746da63cdbf1a5d594fb474c…   (96-char hex)
```

- `.env.local` is in `.gitignore` (`.env*` pattern), so it is **not** in the Git history — this is good.
- However, the file exists on the developer workstation and would be included in any disk backup, workspace snapshot, or AI-agent context window (as happened in this review).
- The Vercel OIDC JWT contains the Vercel team ID (`team_en6ovj0xOPducnXeDfcOxaXZ`), project ID, user ID, and is scoped to the `development` environment. Though it has an `exp` claim, it could be used until expiry to authenticate API calls against Vercel's OIDC-protected resources for this project.

**Fix:**  
1. Rotate the `NEXTAUTH_SECRET` immediately (the value is now exposed in this audit context).
2. The Vercel OIDC token is short-lived and auto-generated by `vercel dev`; confirm it has expired. If not, force-rotate via `vercel env rm` / re-link.
3. Add a pre-commit hook (e.g., `git-secrets` or `gitleaks`) to prevent accidental commits of high-entropy strings.

---

#### P0-3: Hardcoded Plaintext Credentials in Source Code

| Detail | Value |
|--------|-------|
| **File** | `src/lib/auth.js:43-47` |
| **Impact** | Anyone who reads the public source code can log in |

**Evidence:**
```js
if (emailInput === user.email && credentials?.password === "password") {
```
- The repo is hosted at `github.com/legertom/principaljonessimulator` and the SECURITY_BRIEF notes "Public GitHub repository."
- Email: `admin@clever.com`, Password: `password` — trivially discoverable.
- `bcryptjs` is listed as a dependency but is **never imported or used anywhere** in the codebase.

**Fix:**  
1. Hash the password with bcryptjs (already a dependency) and compare with `bcrypt.compare()`.
2. Move the credential to environment variables (`DEMO_ADMIN_EMAIL`, `DEMO_ADMIN_PASSWORD_HASH`).
3. Better yet: remove the Credentials provider entirely for production and restrict it to `NODE_ENV !== 'production'`.

---

### P1 — High (Address Within 1 Week)

#### P1-1: JWT Session MaxAge of 30 Days Is Excessive

| Detail | Value |
|--------|-------|
| **File** | `src/lib/auth.js:59-60` |
| **Impact** | Stolen session tokens remain valid for a month |

**Evidence:**
```js
session: {
    strategy: "jwt",
    maxAge: 30 * 24 * 60 * 60, // 30 days
},
```
For a training simulator with no persistent user data, 30-day sessions are unnecessary and increase the window for session hijacking.

**Fix:** Reduce to 8 hours (`8 * 60 * 60`) for a training app. Add a sliding window refresh if needed.

---

#### P1-2: In-Memory Rate Limiter Does Not Survive Restarts or Scale

| Detail | Value |
|--------|-------|
| **File** | `src/lib/security/rateLimit.js` |
| **Impact** | Rate limits reset on every Vercel cold start; trivially bypassed by rotating IPs |

**Evidence:**
```js
const loginAttempts = new Map();
```
Vercel serverless functions spin up fresh containers frequently. Each cold start clears the Map. An attacker can also bypass by varying the `x-forwarded-for` header (which is attacker-controlled behind many proxies).

**Fix:**  
1. For Vercel: use Vercel KV (Redis) or Upstash for rate-limit state.
2. At minimum, add `x-real-ip` fallback and validate that the rate-limit identifier is harder to spoof.
3. Consider Vercel's built-in WAF/rate-limiting if on a paid plan.

---

#### P1-3: No CSRF Protection Beyond NextAuth Defaults

| Detail | Value |
|--------|-------|
| **File** | `SECURITY_BRIEF.md` claims "Double Submit Cookie pattern" |
| **Impact** | Misleading documentation; actual CSRF posture relies entirely on NextAuth defaults |

**Evidence:**
- `SECURITY_BRIEF.md` §5 states: "CSRF Protection: Double Submit Cookie pattern enforcement on all state-changing requests."
- There is no custom CSRF implementation anywhere in the codebase (`grep -rn "csrf\|CSRF" src/` returns zero results).
- NextAuth.js v4 does include a CSRF token on its own `/api/auth/*` endpoints, but this does not cover any future custom API routes.
- With the middleware being inert (P0-1), even NextAuth's CSRF protections are somewhat moot since unauthenticated access is possible.

**Fix:**  
1. Correct the SECURITY_BRIEF.md to accurately describe the CSRF posture.
2. If custom API routes are added in the future, implement explicit CSRF protection.

---

#### P1-4: CSP Missing `frame-ancestors` Directive

| Detail | Value |
|--------|-------|
| **File** | `next.config.mjs` |
| **Impact** | Clickjacking via iframes on browsers that ignore `X-Frame-Options` |

**Evidence:**
```js
value: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; ..."
```
The CSP sets `X-Frame-Options: DENY` (good), but does not include `frame-ancestors 'none'` in the CSP itself. Modern browsers prioritize CSP `frame-ancestors` over the `X-Frame-Options` header.

**Fix:** Add `frame-ancestors 'none';` to both production and development CSP strings.

---

### P2 — Medium (Address Within 1 Month)

#### P2-1: 15 npm Audit Vulnerabilities (14 High, 1 Moderate)

| Detail | Value |
|--------|-------|
| **Source** | `npm audit` output |
| **Impact** | Dev toolchain compromise; potential CI supply-chain risk |

**Evidence:**
```
15 vulnerabilities (1 moderate, 14 high)
```
All are in the eslint/typescript-eslint dependency tree via `minimatch`. These are dev-only dependencies and do not ship in the production bundle, but they run in CI and on developer machines.

**Fix:**  
1. Run `npm audit fix` to resolve non-breaking updates.
2. Set up Dependabot or Renovate for automated dependency updates (currently absent).

---

#### P2-2: No Dependency Update Automation (Dependabot/Renovate)

| Detail | Value |
|--------|-------|
| **Files** | `.github/dependabot.yml` — missing |
| **Impact** | Known vulnerabilities accumulate silently |

**Fix:** Add `.github/dependabot.yml` targeting npm with weekly frequency.

---

#### P2-3: `ALLOW_PROTECTED_CHANGES=1` Bypass in CI Guard

| Detail | Value |
|--------|-------|
| **File** | `scripts/check-protected-paths.mjs:46-48` |
| **Impact** | Any committer can bypass the protected-path check by setting an env var |

**Evidence:**
```js
if (process.env.ALLOW_PROTECTED_CHANGES === '1') {
    console.warn('⚠️  ALLOW_PROTECTED_CHANGES is set. Bypassing protected path check.');
    process.exit(0);
}
```
This runs in CI. If a workflow is modified (or a contributor sets this variable in their fork's CI), the security file guard is silently disabled.

**Fix:**  
1. Remove the bypass or restrict it to a GitHub environment secret that only admins can set.
2. Add a CODEOWNERS file requiring review from a security-designated team for files matching `src/lib/security/**`, `src/lib/auth.js`, and `next.config.mjs`.

---

#### P2-4: `SECURITY_BRIEF.md` Contains Multiple Inaccurate Claims

| Detail | Value |
|--------|-------|
| **File** | `SECURITY_BRIEF.md` |
| **Impact** | Misleading security posture for reviewers |

**Inaccuracies identified:**
| Claim | Reality |
|-------|---------|
| "Global Middleware: A strict `proxy.js` layer intercepts all requests" | `proxy.js` is never loaded as middleware (P0-1) |
| "CSRF Protection: Double Submit Cookie pattern enforcement" | No custom CSRF code exists (P1-3) |
| "HttpOnly, SameSite=Lax, and Secure cookies" | These are NextAuth defaults, not explicitly configured — and with middleware inert, sessions may not even be required |

**Fix:** Rewrite SECURITY_BRIEF.md to reflect actual controls, not aspirational ones.

---

#### P2-5: Unused `bcryptjs` Dependency

| Detail | Value |
|--------|-------|
| **File** | `package.json` |
| **Impact** | Dead code increases attack surface; misleadingly suggests passwords are hashed |

**Evidence:**
```json
"bcryptjs": "^3.0.3"
```
Zero imports of `bcrypt` anywhere in `src/`. The hardcoded credential comparison uses plaintext string equality (P0-3).

**Fix:** Either use it (hash the demo password) or remove it to reduce supply chain surface.

---

## Recommended Fixes (Quick Reference)

| ID | Severity | Fix | Effort |
|----|----------|-----|--------|
| P0-1 | Critical | Rename `proxy.js` → `middleware.js`; add E2E auth gate test | 30 min |
| P0-2 | Critical | Rotate NEXTAUTH_SECRET; add pre-commit secret scanning | 1 hour |
| P0-3 | Critical | Hash credential with bcryptjs; move to env vars or disable in prod | 1 hour |
| P1-1 | High | Reduce `maxAge` to 8 hours | 5 min |
| P1-2 | High | Migrate rate limiter to Vercel KV or Upstash | 2–4 hours |
| P1-3 | High | Correct SECURITY_BRIEF; plan CSRF for future API routes | 30 min |
| P1-4 | High | Add `frame-ancestors 'none'` to CSP | 5 min |
| P2-1 | Medium | `npm audit fix`; evaluate remaining advisories | 30 min |
| P2-2 | Medium | Add Dependabot config | 15 min |
| P2-3 | Medium | Remove env-var bypass; add CODEOWNERS | 30 min |
| P2-4 | Medium | Rewrite SECURITY_BRIEF.md | 1 hour |
| P2-5 | Medium | Use bcryptjs or remove it | 15 min |

---

## Phased Remediation Plan

### Phase A — Emergency (Today)
1. **Rename `src/proxy.js` → `src/middleware.js`** (P0-1). Test locally that `/dashboard` redirects to `/login` for unauthenticated users. Deploy immediately.
2. **Rotate `NEXTAUTH_SECRET`** (P0-2). Generate new value with `openssl rand -hex 48`. Update in Vercel environment variables. Redeploy.
3. **Hash the demo credential** (P0-3). Import bcryptjs, pre-compute hash for "password", use `bcrypt.compare()` in the authorize function.

### Phase B — This Week
4. Reduce JWT `maxAge` to 8 hours (P1-1).
5. Add `frame-ancestors 'none'` to CSP in `next.config.mjs` (P1-4).
6. Correct all inaccurate claims in `SECURITY_BRIEF.md` (P1-3, P2-4).
7. Add an E2E test that verifies unauthenticated access to `/dashboard/admin-team` returns a redirect to `/login`.

### Phase C — Next Two Weeks
8. Migrate rate limiter to Vercel KV / Upstash (P1-2).
9. Run `npm audit fix` and resolve remaining advisories (P2-1).
10. Add `.github/dependabot.yml` for automated dependency updates (P2-2).
11. Remove `ALLOW_PROTECTED_CHANGES` env bypass; add `CODEOWNERS` file (P2-3).
12. Remove or use `bcryptjs` (P2-5).

### Phase D — Ongoing
13. Install `gitleaks` as a pre-commit hook to prevent future secret commits.
14. Consider adding GitHub secret scanning (free for public repos).
15. Evaluate disabling the Credentials provider entirely in production (`NODE_ENV === 'production'`).
16. Monitor npm audit in CI (add `npm audit --audit-level=high` as a CI step).

---

*End of report.*
